# GitHub-Primary Storage Architecture

This document describes the GitHub-primary storage implementation for the Storyteller system, enabling both persistent service and ephemeral pipeline deployment contexts.

## Overview

The GitHub storage architecture uses GitHub Issues as the primary data store for story hierarchies, with optional SQLite caching for performance in persistent deployments. This approach provides:

- **Single Source of Truth**: GitHub Issues serve as the authoritative data store
- **Human-Readable Format**: Stories are stored in human-readable format with structured metadata
- **Cross-Repository Support**: Stories can span multiple repositories with proper relationships
- **Expert Analysis Integration**: Analysis and comments are stored as GitHub issue comments
- **Deployment Flexibility**: Supports both ephemeral (pipeline) and persistent (MCP) contexts

## Configuration

### Environment Variables

```bash
# Storage Configuration
STORAGE_PRIMARY=github                    # "github" or "sqlite" 
STORAGE_CACHE_ENABLED=false             # Enable SQLite cache for performance
DEPLOYMENT_CONTEXT=pipeline             # "pipeline" or "mcp"
STORAGE_LABEL_PREFIX=storyteller        # GitHub label prefix
```

### JSON Configuration (.storyteller/config.json)

```json
{
  "storage": {
    "primary": "github",
    "cache_enabled": false,
    "deployment_context": "pipeline",
    "issue_label_prefix": "storyteller",
    "epic_label": "epic",
    "user_story_label": "user-story",
    "sub_story_label": "sub-story"
  }
}
```

## Issue Structure

### Epic Issues

Epic issues contain YAML frontmatter with structured metadata:

```markdown
---
epic_id: epic_001
story_type: epic
target_repositories:
  - backend
  - frontend
status: planning
business_value: High customer value
estimated_duration_weeks: 4
acceptance_criteria:
  - Feature works correctly
  - Performance is acceptable
created_at: '2024-01-01T00:00:00+00:00'
updated_at: '2024-01-01T00:00:00+00:00'
metadata:
  priority: high
---

# Epic: User Authentication System

This epic implements a complete user authentication system with OAuth support
and secure session management.

## Business Value
Enable secure user access and personalized experiences.

## Acceptance Criteria
- Users can register with email/password
- OAuth integration with Google/GitHub
- Secure session management
- Password reset functionality
```

**Labels**: `storyteller`, `epic`

### User Story Issues

User story issues reference their parent epic:

```markdown
---
user_story_id: story_001
story_type: user_story
epic_id: epic_001
target_repositories:
  - frontend
status: ready
user_persona: Busy Professional
user_goal: Quick and secure login
acceptance_criteria:
  - Google OAuth button on login page
  - Successful authentication redirects to dashboard
story_points: 5
created_at: '2024-01-01T00:00:00+00:00'
updated_at: '2024-01-01T00:00:00+00:00'
metadata: {}
---

# User Story: OAuth Integration

As a busy professional, I want to login with my Google account so that 
I don't need to remember another password.

## Acceptance Criteria
- Google OAuth button prominently displayed on login page
- Successful authentication redirects to user dashboard
- User profile populated from OAuth data automatically
```

**Labels**: `storyteller`, `user-story`

### Sub-Story Issues

Sub-story issues are department-specific implementation tasks:

```markdown
---
sub_story_id: substory_001
story_type: sub_story
user_story_id: story_001
department: backend
target_repository: backend
status: in_progress
technical_requirements:
  - OAuth 2.0 implementation
  - JWT token management
  - User session storage
assignee: developer@example.com
estimated_hours: 8.0
created_at: '2024-01-01T00:00:00+00:00'
updated_at: '2024-01-01T00:00:00+00:00'
metadata: {}
---

# Sub-Story (backend): OAuth API Implementation

Implement backend OAuth endpoints and session management for Google authentication.

## Technical Requirements
- OAuth 2.0 flow implementation
- JWT token generation and validation
- Secure user session storage
- Rate limiting and security controls
```

**Labels**: `storyteller`, `sub-story`, `department:backend`

## Expert Analysis Comments

Expert analyses are stored as structured comments on relevant issues:

```markdown
## Expert Analysis: security-expert

### Analysis
OAuth implementation looks solid. Need to ensure proper token validation 
and secure session management.

### Recommendations
- Use industry-standard OAuth libraries
- Implement proper CSRF protection
- Add rate limiting to auth endpoints

### Concerns
- Token storage security
- Session timeout handling

### Additional Information
**security_score**: 8
**complexity**: medium
**estimated_hours**: 8

---
*This analysis was generated by the Storyteller AI expert system*
```

## API Usage

### Basic Storage Operations

```python
from github_storage import GitHubStorageManager, StorageConfig
from config import Config

# Configure storage
config = Config(
    github_token="your_token",
    storage=StorageConfig(
        primary="github",
        deployment_context="pipeline"
    )
)

# Initialize storage manager
storage = GitHubStorageManager(config)

# Save Epic
epic = Epic(
    title="User Authentication System",
    description="Complete OAuth implementation",
    target_repositories=["backend", "frontend"]
)
issue = await storage.save_epic(epic, "owner/backend")

# Save Expert Analysis  
analysis = StoryAnalysis(
    role_name="security-expert",
    analysis="OAuth implementation needs security review",
    recommendations=["Use standard libraries", "Add CSRF protection"]
)
await storage.save_expert_analysis(issue.number, analysis, "owner/backend")

# Reconstruct Story Hierarchy
hierarchy = await storage.reconstruct_story_hierarchy(issue.number, "owner/backend")
```

### Integration with StoryProcessor

```python
from story_manager import StoryProcessor

processor = StoryProcessor(config)

# Create Epic with GitHub storage
epic = await processor.create_epic_with_github_storage(
    title="API Modernization",
    description="Modernize legacy API infrastructure",
    target_repositories=["backend"],
    repository_name="owner/backend"
)
```

## Deployment Contexts

### Ephemeral Mode (Pipeline)

For GitHub Actions and CI/CD pipelines:

```bash
export STORAGE_PRIMARY=github
export DEPLOYMENT_CONTEXT=pipeline
export STORAGE_CACHE_ENABLED=false
```

- GitHub Issues as primary and only storage
- No local caching (stateless)
- Optimized for short-lived execution contexts

### Persistent Mode (MCP Server)

For long-running MCP server deployments:

```bash
export STORAGE_PRIMARY=github
export DEPLOYMENT_CONTEXT=mcp
export STORAGE_CACHE_ENABLED=true
```

- GitHub Issues as primary storage
- Optional SQLite cache for performance
- Optimized for persistent service contexts

## Benefits

### Single Source of Truth
- GitHub Issues serve as the authoritative data store
- No split-brain scenarios between local and remote state
- Consistent data access across deployment contexts

### Human-Readable Format
- Stories stored in Markdown with YAML frontmatter
- Easily readable and editable by humans
- Supports rich formatting and links

### Cross-Repository Collaboration
- Stories can span multiple repositories
- Proper cross-references between related issues
- Department-specific assignment and tracking

### Expert System Integration
- AI analyses stored as structured comments
- Role-based analysis tracking
- Consensus and discussion history preserved

### Deployment Flexibility
- Works in both ephemeral and persistent contexts
- Optional caching for performance optimization
- Graceful fallback to SQLite when needed

## Migration Strategy

### From SQLite to GitHub

The system maintains backward compatibility:

1. **Dual Mode**: Both storage systems can coexist
2. **Gradual Migration**: Move stories incrementally to GitHub
3. **Fallback Support**: SQLite remains available as fallback
4. **Data Export**: Tools to export existing SQLite data to GitHub format

### Configuration-Driven Selection

Storage backend selection is configuration-driven:

```python
# SQLite (existing)
storage = StorageConfig(primary="sqlite")

# GitHub (new)
storage = StorageConfig(primary="github")

# GitHub with SQLite cache
storage = StorageConfig(
    primary="github", 
    cache_enabled=True,
    deployment_context="mcp"
)
```

## Best Practices

### Issue Organization
- Use consistent labeling with `storyteller` prefix
- Apply department-specific labels for sub-stories
- Maintain proper epic → user story → sub-story relationships

### Repository Management
- Create stories in the most relevant repository
- Use cross-references for multi-repository stories
- Keep epic issues in a central planning repository

### Expert Analysis
- Store analyses as comments on relevant issues
- Use structured format for machine readability
- Preserve discussion threads and consensus history

### Performance Optimization
- Enable SQLite caching for persistent deployments
- Use GitHub search API efficiently for large repositories
- Implement lazy loading for story hierarchies

## Troubleshooting

### Common Issues

**Issue**: Stories not appearing in hierarchy reconstruction
- **Solution**: Verify YAML frontmatter formatting and required fields

**Issue**: GitHub API rate limiting
- **Solution**: Implement request throttling and use authenticated requests

**Issue**: Missing expert analyses
- **Solution**: Check comment formatting and issue number references

**Issue**: Cross-repository references broken
- **Solution**: Verify repository names and access permissions

### Debugging

Enable debug logging to troubleshoot issues:

```bash
export LOG_LEVEL=DEBUG
```

Check GitHub API responses and YAML parsing:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Future Enhancements

- **GitHub Projects Integration**: Automatic project board management
- **Webhook Support**: Real-time status updates from GitHub events  
- **Advanced Search**: Enhanced story discovery and filtering
- **Bulk Operations**: Efficient batch creation and updates
- **Template System**: Standardized issue templates for story types